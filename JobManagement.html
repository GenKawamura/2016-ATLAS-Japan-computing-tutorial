<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<link rel="stylesheet" href="css/common.css" type="text/css" />
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" src="scripts/shCore.js" charset="Shift_JIS"></script>
<script type="text/javascript" src="scripts/shBrushCss.js"></script>
<script type="text/javascript" src="scripts/shBrushCpp.js"></script>
<script type="text/javascript" src="scripts/shBrushPython.js"></script>
<script type="text/javascript" src="shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="styles/shCore.css" />
<link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css" />
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<title>ATLASソフトウェア講習会2016.12</title>
<!--[if lt IE 7]>
<script src="http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js" type="text/javascript"></script>
<![endif]-->
</head>
<body>
<div id="top">
   <div id="header">
      <h1><a href="index.html">ATLASソフトウェア講習会2016.12</a></h1>
   <!-- /#topicPath --></div>
   <div id="contents">
      <div id="main">
         <h2>このチュートリアル用のスライド</h2>
         <p>
	   <a href="slides/job_management.pdf">チュートリアル用ショートスライド (ジョブ管理等)</a> 
	 </p>
         <h2>ATALSでの分散計算環境での解析処理の投入方法(Gridジョブ)</h2>

ATLASのユーザー解析ジョブをGridに投入するには<a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PanDA">Production ANd Distributed Analysis (PanDA)</a>というシステムを使います。
Athenaのジョブを投入する場合は<font color="red">pathena</font>、Rootやその他の一般のジョブを投入する場合は<font color="red">prun</font>というコマンドを使います。
それでは、このpathenaやprunといったPanDAクライアントの使い方を確認していきます。
         </p>

<h2>Pathena Hello World ジョブ</h2>
         <p>
Athenaの環境設定から始めましょう。
<dl>
<dd>$ mkdir -v tutorial2016; cd tutorial2016</dd>
<dd>$ setupATLAS</dd>
<dd>$ asetup AtlasProduction 20.7.5.1 here</dd>
</dl>
適当なディレクトリを作成して、HelloWorldOptions.pyを取得します。
<dl>
<dd>$ get_files -jo HelloWorldOptions.py</dd>
</dl>
Pandaクライアントを設定して、HelloWorldOptions.pyをグリッドジョブとして投入しましょう。
<dl>
<dd>$ lsetup emi </dd>
<dd>$ lsetup panda </dd>
<dd>$ pathena HelloWorldOptions.py --outDS user.<font color="red">YourNickname</font>.tutorial2016.12 --noOutput </dd>
</dl>
エラーが出る場合は、voms-proxy-destroyでプロキシ証明書を破棄してから、もう一度試してください
(ジョブの投入時にプロキシ証明書の生成を行うことが出来ます)。さて、Athenaジョブを投入する場合は、
athena.py -> pathenaという置き換えでよいことがわかります。--outDSでアウトプットデータセットの名前を指定しますが、
証明書に設定したnicknameを使って<font color="red">user.YourNickname.XXX</font>としてください。nicknameは以下のようにして調べられます。
<dl>
<dd>$ voms-proxy-info --all | grep nickname </dd>
</dl>
HelloWorldOptions.pyはファイルを出力しないので、--noOutputとしています。
他にも様々なオプションが定義されているので、pathena --helpで一度確認してみてください。
それでは、pbookでジョブの状態を確認します。
<dl>
<dd>$ pbook </dd>
<dd>INFO : Synchronizing local repository ...</dd>
<dd>INFO : Got 1 jobs to be updated</dd>
<dd>INFO : Updating JobID=120308 ...</dd>
<dd>INFO : Synchronization Completed</dd>
<dd>INFO : Done</dd>

<dd>Start pBook 0.5.61</dd>
<dd>>>> show()</dd>
<dd>======================================</dd>
<dd>     jediTaskID : 10262517</dd>
<dd>     taskStatus : done</dd>
<dd>       JobsetID : 94</dd>
<dd>           type : panda-client-0.5.72-jedi-athena</dd>
<dd>        release : Atlas-20.7.5</dd>
<dd>          cache : AtlasProduction-20.7.5.1</dd>
<dd>           inDS : </dd>
<dd>          outDS : user.gkawamur.tutorial2016.12.log/</dd>
<dd>   creationTime : 2016-12-19 14:49:51</dd>
<dd>     lastUpdate : 2016-12-19 14:51:43</dd>
<dd>         params : pathena HelloWorldOptions.py --outDS user.gkawamur.tutorial2016.12 --noOutput</dd>
<dd>    inputStatus : </dd>
<dd>             finished : 1</dd>
<dd></dd>
</dl>
show()コマンドでPanDA Taskの状態を確認しています。
上記のように表示されれば正常に動作しています。Ctrl-Dで抜けます。

<a href="http://bigpanda.cern.ch">PanDA monitor</a>でも確認してみましょう。
User Searchに自分のニックネーム、あるいはTask Searchに先ほど投入したジョブのTask IDを入れて、Submitを押すとジョブの状態が確認出来ます。
タスクを辿るとBuildジョブとRunジョブを発見できます。
</br></br>
<div align="center"><img src="./images/panda_job_output.png"></div>
</br>
グリッドジョブやAthenaやPanDA Pilot等、一連のログファイルはPanDA monitorからブラウザを使っても見れますが、ここではRunジョブのログコンテナからRucioでローカルディスクへダウンロードしてチェックしてみます。
</br>
</br>
<div align="center"><img src="./images/panda_log_container.png"></div>
</br>
<dl>
<dd>$ rucio download user.gkawamur.tutorial2016.12.log/ </dd>
<dd>$ cd user.gkawamur.tutorial2016.12.log</dd>
<dd>$ tar zxvf user.gkawamur.tutorial2016.12.log.10262517.000001.log.tgz</dd> 
<dd>tarball_PandaJob_3131853110_ANALY_IEPSAS-Kosice/</dd>
<dd>tarball_PandaJob_3131853110_ANALY_IEPSAS-Kosice/memory_monitor_summary.json</dd>
<dd>tarball_PandaJob_3131853110_ANALY_IEPSAS-Kosice/jobState-3131853110.pickle</dd>
<dd>tarball_PandaJob_3131853110_ANALY_IEPSAS-Kosice/PoolFileCatalog.xml</dd>
<dd>tarball_PandaJob_3131853110_ANALY_IEPSAS-Kosice/athena_stdout.txt</dd>
<dd>...</dd>
<dd>$ less tarball_PandaJob_3131853110_ANALY_IEPSAS-Kosice/athena_stdout.txt</dd>
</dl>

pathena HelloWorldプログラムが正しく動いたことが分かります。pathenaの代わりに、athenaで実行してもローカルで同様の結果が得られることも（時間があれば）確認してみてください。
<dl>
<dd>$ athena HelloWorldOptions.py </dd>
</dl>

</p>
<h2>Pathena テストジョブ</h2>
<p>

</br>
<b>Evgen イベントジェネレーター</b>
</br>
最初にEvgenを動かしてみましょう。

<dl>
<dd>$ asetup 17.2.4,here,setup</dd>
</dl>
まず、athenaで（ローカルマシン上で）動くか見てみましょう。<a href="athena_job_options/jobOptions.pythia16.py">このPythiaジョブオプションファイル</a>をダウンロードしてください。このジョブオプションでは５イベントのみを生成します。
<dl>
<dd>$ athena jobOptions.pythia16.py</dd>
</dl>

Evgen用のジョブオプションファイルを指定して、５つのジョブをグリッドへ投入します。MC用出力データセットの命名規約は<a href="https://cds.cern.ch/record/1070318/files/gen-int-2007-001.pdf">ここ</a>を参照してください。
<dl>
<dd>$ lsetup panda</dd>
<dd>$ pathena jobOptions.pythia16.py --outDS user.<font color="red">YourNickname</font>.456.ccaho.evgen.pool.v5 --split 5</dd>
</dl>
pbook、あるいはPandaMonitorで確認してみてください。終了までには10-15分ほど時間がかかります。</br>

</br>
<b>Analysis スケルトン</b>
</br>
次にAnalysis用のスケルトンをテストデータセットを使って動かしてみます。



ジョブの出力ファイルは、ジョブが実行されたサイトの<font color="red">SCRATCHDISK</font>に書き出されます。しかし、SCRATCHDISKは長くて2週間、残り容量によってはもっと早いうちに自動的に消去されます。出力ファイルをある程度の期間保管したい場合や、Gridジョブで再利用したいジョブを投入する際に出力ファイルの転送先を<font color="red">--destSE</font>オプションで指定します。例えば、TOKYO-LCG2_LOCALGROUPDISKに転送する場合には以下のようになります。
<dl>
<dd>$ pathena HelloWorldOptions.py --outDS user.<font color="red">YourNickname</font>.tutorial2016.1 --noOutput --destSE TOKYO-LCG2_LOCALGROUPDISK</dd>
</dl>

</p>
<h2>prun Hello World ジョブ</h2>
<p>

次は、prunによりHello Worldジョブを投入してみます。まずは、簡単なスクリプトでテストしてみましょう。
<dl>
<dd>$ mkdir grid; cd grid</dd>
<dd>$ echo -e "hostname > test.out\nprintenv >> test.out" > test.sh </dd>
<dd>$ chmod +x test.sh</dd>
</dl>
それでは、prunでジョブを投入します。
<dl>
<dd>$ lsetup panda</dd>
<dd>$ prun --exec "test.sh" --outDS user.<font color="red">YourNickname</font>.tutorial2016.12 --outputs test.out</dd>
</dl>
--outputsオプションで出力ファイルを指定しています。例えば、ROOTを実行して、histograms.rootというようなファイルを生成する場合には--outputs histograms.rootとするわけです。さて、prunを実行するには prun --exec "実行コマンド"だけでよいことが分かります。pathenaと同様にpbookやPanDA monitorを使ってジョブを確認してください。ジョブが終了したら、出力ファイルをローカルに取り寄せます。
<dl>
<dd>$ rucio download user.gkawamur.tutorial2016.12_test.out/</dd>
<dd>$ cat user.gkawamur.tutorial2016.12_test.out/user.gkawamur.7939538._000001.test.out</dd>
</dl>

         </p>
<h2>prun xAOD 解析ジョブ</h2>
         <p>
さて、一般にグリッド上のxAODをROOTで解析したい場合には、以下のようにコードを用意します。
<pre class="brush:cpp">
#include &lt;TROOT.h&gt;
#include &lt;TChain.h&gt;
#include &lt;TFile.h&gt;

void macrotest()
{
  // read a string via file since long string causes memory error in CINT when it is read via stdin
  std::string argStr;
  std::ifstream ifs("input.txt");
  std::getline(ifs,argStr);

  // split by ','
  std::vector&lt;std::string&gt; fileList;
  for (size_t i=0,n; i <= argStr.length(); i=n+1) {
    n = argStr.find_first_of(',',i);
    if (n == string::npos)
    n = argStr.length();
    string tmp = argStr.substr(i,n-i);
    fileList.push_back(tmp);
  }

  // open input files
  TChain fChain("CollectionTree");
  for (int iFile=0; iFile < fileList.size(); ++iFile) {
    std::cout &lt;&lt; "open " &lt;&lt; fileList[iFile].c_str() &lt;&lt; std::endl;
    fChain.Add(fileList[iFile].c_str());
  }

  // main loop
...
...

}
</pre>
ジョブを投入すコマンドは以下のようになります。
<dl>
<dd>$ prun --exec "echo %IN > input.txt; root.exe -b -q macrotest.C" --inDS ...</dd>
</dl>
--inDSで指定したデータセットの中にあるファイル名をinput.txtに書き出して、
macrotest.Cがinput.txtに書かれたファイルを読み込んでいく、という順番です。しかし、
<a href="RootCore">xAOD (ROOT)</a>で用いたEventLoopにはprun用のドライバが用意されているので、
手順を簡単にできます。では、実際にxAODの解析ジョブをグリッドに投入してみましょう。クリーンな環境で始めるために、
新しいセッションを開いて、環境設定から始めます。
<dl>
<dd>$ setupATLAS</dd>
<dd>$ lsetup panda</dd>
<dd>$ lsetup rcsetup</dd>
<dd>$ cd grid</dd>
</dl>
run/ATestRun.cxxをATestSubmit.cxxとしてgridディレクトリにコピーしておきます。ATestSubmit.cxxの内容は以下です。
<pre class="brush:cpp">
void ATestSubmit (const std::string& submitDir)
{
  // Set up the job for xAOD access:
  xAOD::Init().ignore();

  // create a new sample handler to describe the data files we use
  SH::SampleHandler sh;

  // use SampleHandler to scan all of the subdirectories of a directory for particular MC single file:
  SH::scanDQ2 (sh, "user.tomoe.tutorial2016.AOD.1");

  // set the name of the tree in our files
  // in the xAOD the TTree containing the EDM containers is "CollectionTree"
  sh.setMetaString ("nc_tree", "CollectionTree");

  // print out the samples we found
  sh.print ();

  // this is the basic description of our job
  EL::Job job;
  job.sampleHandler (sh); // use SampleHandler in this job
  job.options()->setDouble (EL::Job::optMaxEvents, 10);

  // define an output and an ntuple associated to that output
  EL::OutputStream output  ("myOutput");
  job.outputAdd (output);
  EL::NTupleSvc *ntuple = new EL::NTupleSvc ("myOutput");
  job.algsAdd (ntuple);

  // add our algorithm to the job
  MyAnalysisAlg *alg = new MyAnalysisAlg;

  // later on we'll add some configuration options for our algorithm that go here
  job.algsAdd (alg);
  alg->outputName = "myOutput";

  // make the driver we want to use:
  // this one works by running the algorithm directly:
  EL::PrunDriver driver;
  driver.options()->setString("nc_outputSampleName", "user.gkawamur.tutorial2016.12");
  // we can use other drivers to run things on the Grid, with PROOF, etc.

  // process the job using the driver
  driver.submitOnly (job, submitDir);
}
</pre>
ローカルで実行する場合に比べて、scanとdriverが変わっています。では、投入します。
<dl>
<dd>$ root -l -b -q '$ROOTCOREDIR/scripts/load_packages.C' 'ATestSubmit.cxx ("myGridJob")'</dd>
</dl>
投入に少々時間がかかります。ジョブが終わればまたRucioでダウンロードしてROOTのTBrowserで見てみましょう。
<dl>
<dd>$ rucio download user.gkawamur.tutorial2016.12_hist/</dd>
<dd>$ root user.gkawamur.tutorial2016.12_hist/user.tomoe.7946627._000001.hist-output.root  </dd>
<dd>root [1] TBrowser t  </dd>
</dl>
グリッドで処理することが出来ました。
         </p>

         <h2>参考文献、リンク等</h2>
         <p>
<a href="http://tomoe.web.cern.ch/tomoe/AtlasSoftWareTutorial/2016/PanDA.html">ATLASソフトウェア講習会2016.01 ジョブ管理</a></br>
<a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PanDA">Twiki - The PanDA Production and Distributed Analysis System</a></br>
<a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaAthena">Twiki - How to submit Athena jobs to Panda</a></br>
<a href="https://twiki.cern.ch/twiki/bin/viewauth/AtlasComputing/SoftwareTutorialGettingDatasets">Software twiki tutorial</a></br>
ATLAS-D meeting 2016 Grid/Rucio Tutorial, Gen Kawamura</br>
<a href="https://twiki.cern.ch/twiki/bin/viewauth/AtlasComputing/SoftwareTutorialUsingTheGrid">Monitoring Your Grid Jobs, Andrew Washbrook University of Edinburgh, ATLAS Software & Computing Tutorials 14th January 2015 PUC, Chile Software tutorial using Grid</a></br>
<a href="https://indico.cern.ch/event/465378/">ATLAS Software Tutorial, Feb 2016</a></br>
<a href="http://iopscience.iop.org/article/10.1088/1742-6596/664/6/062065/meta">Calafiura, Paolo, et al. "The ATLAS Event Service: A new approach to event processing." Journal of Physics: Conference Series. Vol. 664. No. 6. IOP Publishing, 2015.</a></br>

         </p>
      <!-- /#main --></div>
      <!-- /#sub --></div>
      <div id="pageTop">
         <a href="#">ページのトップへ戻る</a>
      <!-- /#pageTop --></div>
   <!-- /#contents --></div>
<!-- /#top --></div>
</body>
</html>
