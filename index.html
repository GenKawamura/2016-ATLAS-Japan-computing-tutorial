<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<link rel="stylesheet" href="css/common.css" type="text/css" />
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" src="scripts/shCore.js" charset="Shift_JIS"></script>
<script type="text/javascript" src="scripts/shBrushCss.js"></script>
<script type="text/javascript" src="scripts/shBrushCpp.js"></script>
<script type="text/javascript" src="scripts/shBrushPython.js"></script>
<script type="text/javascript" src="shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="styles/shCore.css" />
<link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css" />
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<title>ATLASソフトウェア講習会2016.12</title>
<!--[if lt IE 7]>
<script src="http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js" type="text/javascript"></script>
<![endif]-->
</head>
<body>
<div id="top">
   <div id="header">
      <h1><a href="index.html">ATLASソフトウェア講習会2016.12</a></h1>
   <!-- /#topicPath --></div>
   <div id="contents">
      <div id="main">
         <h2>このチュートリアル用のスライド</h2>
         <p>
	   <a href="slides/grid_computing.pdf">grid_computing.pdf</a></br> 
	   <a href="slides/job_management.pdf">job_management.pdf</a> 
	 </p>
         <h2>ATALSでの分散計算環境での解析処理の投入方法(Gridジョブ)</h2>

ATLASのユーザー解析ジョブをGridに投入するには<a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PanDA">Production ANd Distributed Analysis (PanDA)</a>というシステムを使います。
Athenaのジョブを投入する場合は<font color="red">pathena</font>、Rootやその他の一般のジョブを投入する場合は<font color="red">prun</font>というコマンドを使います。
それでは、このpathenaやprunといったPanDAクライアントの使い方を確認していきます。
         </p>
<h2>環境設定</h2>
         <p>
login.icepp.jpあるいはlxplus.chでPanDAクライアントを使うためには以下の手順で設定を行ってください。
<dl>
<dd>$ export ATLAS_LOCAL_ROOT_BASE=/cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase</dd>
<dd>$ alias setupATLAS='source ${ATLAS_LOCAL_ROOT_BASE}/user/atlasLocalSetup.sh'</dd>
<dd>$ setupATLAS</dd>
</dl>
EMI-UIをセットアップします。
<dl>
<dd>$ localSetupEmi</dd>
</dl>
Proxy証明書を作ります。
<dl>
<dd>$ voms-proxy-init -voms atlas</dd>
</dl>
Panda Clientをセットアップします。
<dl>
<dd>$ localSetupPandaClient</dd>
</dl>
pbookというジョブのbookkeepingアプリケーションを起動してみましょう。
<dl>
<dd>$ pbook</dd>
<dd>INFO : Synchronizing local repository ...</dd>
<dd>INFO : Got 0 jobs to be updated</dd>
<dd>INFO : Synchronization Completed</dd>
<dd>INFO : Done</dd>
<dd></dd>
<dd>Start pBook 0.5.61</dd>
<dd>>>> </dd>
</dl>
上記のように表示されれば正常に動作しています。Ctrl-Dで抜けます。
         </p>
<h2>Pathenaの使い方</h2>
         <p>
新しいセッションを開いて、Athenaの環境設定から始めましょう。
<dl>
<dd>$ setupATLAS</dd>
<dd>$ cd tutorial2016</dd>
<dd>$ asetup AtlasProduction 20.7.5.1 here</dd>
</dl>
適当なディレクトリを作成して、HelloWorldOptions.pyを取得します。
<dl>
<dd>$ get_files -jo HelloWorldOptions.py</dd>
</dl>
Pandaクライアントを設定して、HelloWorldOptions.pyをグリッドジョブとして投入しましょう。
<dl>
<dd>$ localSetupPandaClient </dd>
<dd>$ pathena HelloWorldOptions.py --outDS user.<font color="red">YourNickname</font>.tutorial2016.1 --noOutput </dd>
</dl>
エラーが出る場合は、voms-proxy-destroyでプロキシ証明書を破棄してから、もう一度試してください
(ジョブの投入時にプロキシ証明書の生成を行うことが出来ます)。さて、Athenaジョブを投入する場合は、
athena.py -> pathenaという置き換えでよいことがわかります。--outDSでアウトプットデータセットの名前を指定しますが、
証明書に設定したnicknameを使って<font color="red">user.YourNickname.XXX</font>としてください。nicknameは以下のようにして調べられます。
<dl>
<dd>$ voms-proxy-info --all | grep nickname </dd>
</dl>
HelloWorldOptions.pyはファイルを出力しないので、--noOutputとしています。
他にも様々なオプションが定義されているので、pathena --helpで一度確認してみてください。
それでは、pbookでジョブの状態を確認します。
<dl>
<dd>$ pbook </dd>
<dd>INFO : Synchronizing local repository ...</dd>
<dd>INFO : Got 1 jobs to be updated</dd>
<dd>INFO : Updating JobID=120308 ...</dd>
<dd>INFO : Synchronization Completed</dd>
<dd>INFO : Done</dd>

<dd>Start pBook 0.5.61</dd>
<dd>>>> show(120308)</dd>
</dl>
JobIDが120308であることがわかります。show()コマンドで確認しています。
<a href="http://bigpanda.cern.ch">PanDA monitor</a>でも確認してみましょう。
Userに自分のニックネームを入れて、Submitを押すとジョブの状態が確認出来ます
(自分のジョブを表示するページはよく使うので、ブックマークしておきましょう)
ジョブが完了すると以下のようなメールが届きます:
<pre style="font-size: 0.9em;color: blue;line-height: 100%;">
Summary of TaskID:7923779

Created : 2016-03-13 22:42:16 (UTC)
Ended   : 2016-03-13 23:05:13.508723 (UTC)

Final Status : done

Total Number of Inputs : 1
            Succeeded : 1
            Failed    : 0
            Cancelled : 0

Error Dialog : None

Log : user.tomoe.tutorial2016.1.log/

Parameters : pathena HelloWorldOptions.py --outDS user.tomoe.tutorial2016.1 --noOutput

PandaMonURL : http://bigpanda.cern.ch/task/7923779/

Report Panda problems of any sort to

 the eGroup for help request
   hn-atlas-dist-analysis-help@cern.ch

 the JIRA portal for software bug
   https://its.cern.ch/jira/browse/ATLASPANDA
</pre>
上記のメールに書かれているログファイルを取り寄せます。
<dl>
<dd>$ rucio download user.tomoe.tutorial2016.1.log/ </dd>
<dd>$ cd user.tomoe.tutorial2016.1.log/</dd>
<dd>$ tar zxvf user.tomoe.tutorial2016.1.log.7923779.000001.log.tgz</dd>
<dd>$ vi tarball_PandaJob_2791426050_ANALY_LPC/athena_stdout.txt</dd>
</dl>
HelloWorldプルグラムが正しく動いたことが分かります。次は、<a href=""Athena.html"">ESD解析 (ROOT)</a>で作成したプログラムをグリッドで実行して、
ヒストグラムをローカルにダウンロードしてみましょう。まず、$TestAreaでMyNewPackageがコンパイルされていることを確認しましょう。
<dl>
<dd>$ cd $TestArea </dd>
<dd>$ ls </dd>
<dd>InstallArea  MyNewPackage  grid</dd>
</dl>
では、投入してみます。
<dl>
<dd>$ cd grid </dd>
<dd>$ cp ../MyNewPackage/run/MyAnalysisAlg_options.py . </dd>
<dd>$ pathena MyAnalysisAlg_options.py --inDS user.tomoe.tutorial2016.ESD.1 --outDS user.<font color="red">YourNickname</font>.tutorial2016.2</dd>
</dl>
MyAnalysisAlg_options.pyの入力ファイルを--inDSで指定しました。pbook、PandaMonitorで確認してみてください。ジョブが完了したら、出力ファイルをダウンロードします。
<dl>
<dd>$ rucio download user.tomoe.tutorial2016.2_MyNewPackage/ </dd>
<dd>$ root user.tomoe.tutorial2016.2_MyNewPackage/user.tomoe.7924057.MyNewPackage._000001.root </dd>
<dd>root [2] TBrowser t</dd>
</dl>
ヒストグラムをダウンロードすることが出来ました。グリッドを使えば、サイズの大きい入力ファイルをわざわざローカルにダウンロードしなくてよいことが分かります。
ジョブの出力ファイルは、ジョブが実行されたサイトの<font color="red">SCRATCHDISK</font>に書き出されます。しかし、SCRATCHDISKは長くて2週間、残り容量によってはもっと早いうちに自動的に消去されます。出力ファイルをある程度の期間保管したい場合や、Gridジョブで再利用したいジョブを投入する際に出力ファイルの転送先を<font color="red">--destSE</font>オプションで指定します。例えば、TOKYO-LCG2_LOCALGROUPDISKに転送する場合には以下のようになります。
<dl>
<dd>$ pathena HelloWorldOptions.py --outDS user.<font color="red">YourNickname</font>.tutorial2016.1 --noOutput --destSE TOKYO-LCG2_LOCALGROUPDISK</dd>
</dl>
         </p>
<h2>prunの使い方</h2>
         <p>
次は、prunにより一般のジョブを投入してみます。まずは、簡単なスクリプトでテストしてみましょう。
<dl>
<dd>$ cd ROOTAnalysisTutorial</dd>
<dd>$ mkdir grid</dd>
<dd>$ cd grid</dd>
<dd>$ cat << EOF > test.sh </dd>
<dd>hostname > test.out </dd>
<dd>printenv >> test.out </dd>
<dd>EOF </dd>
<dd>$ chmod +x test.sh</dd>
</dl>
それでは、投入します。
<dl>
<dd>$ setupATLAS</dd>
<dd>$ localSetupPandaClient</dd>
<dd>$ prun --exec "test.sh" --outDS user.<font color="red">YourNickname</font>.tutorial2016.3 --outputs test.out</dd>
</dl>
--outputsオプションで出力ファイルを指定しています。例えば、ROOTを実行して、histograms.rootというようなファイルを生成する場合には--outputs histograms.rootとするわけです。さて、prunを実行するには prun --exec "実行コマンド"だけでよいことが分かります。pathenaと同様にpbookやPanDA monitorを使ってジョブを確認してください。ジョブが終了したら、出力ファイルをローカルに取り寄せます。
<dl>
<dd>$ rucio download user.tomoe.tutorial2016.3_test.out/</dd>
<dd>$ cat user.tomoe.tutorial2016.3_test.out/user.tomoe.7939538._000001.test.out</dd>
</dl>
さて、一般にグリッド上のNtupleをROOTで解析したい場合には、以下のようにコードを用意します。
<pre class="brush:cpp">
#include &lt;TROOT.h&gt;
#include &lt;TChain.h&gt;
#include &lt;TFile.h&gt;

void macrotest()
{
  // read a string via file since long string causes memory error in CINT when it is read via stdin
  std::string argStr;
  std::ifstream ifs("input.txt");
  std::getline(ifs,argStr);

  // split by ','
  std::vector&lt;std::string&gt; fileList;
  for (size_t i=0,n; i <= argStr.length(); i=n+1) {
    n = argStr.find_first_of(',',i);
    if (n == string::npos)
    n = argStr.length();
    string tmp = argStr.substr(i,n-i);
    fileList.push_back(tmp);
  }

  // open input files
  TChain fChain("CollectionTree");
  for (int iFile=0; iFile < fileList.size(); ++iFile) {
    std::cout &lt;&lt; "open " &lt;&lt; fileList[iFile].c_str() &lt;&lt; std::endl;
    fChain.Add(fileList[iFile].c_str());
  }

  // main loop
...
...

}
</pre>
ジョブを投入すコマンドは以下のようになります。
<dl>
<dd>$ prun --exec "echo %IN > input.txt; root.exe -b -q macrotest.C" --inDS ...</dd>
</dl>
--inDSで指定したデータセットの中にあるファイル名をinput.txtに書き出して、
macrotest.Cがinput.txtに書かれたファイルを読み込んでいく、という順番です。しかし、
<a href="RootCore">xAOD (ROOT)</a>で用いたEventLoopにはprun用のドライバが用意されているので、
少々手順を簡単にできます。では、実際にxAODの解析ジョブをグリッドに投入してみましょう。クリーンな環境で始めるために、
新しいセッションを開いて、環境設定から始めます。
<dl>
<dd>$ cd ROOTAnalysisTutorial</dd>
<dd>$ setupATLAS</dd>
<dd>$ localSetupPandaClient</dd>
<dd>$ lsetup rcsetup</dd>
<dd>$ cd grid</dd>
</dl>
run/ATestRun.cxxをATestSubmit.cxxとしてgridディレクトリにコピーしておきます。ATestSubmit.cxxの内容は以下です。
<pre class="brush:cpp">
void ATestSubmit (const std::string& submitDir)
{
  // Set up the job for xAOD access:
  xAOD::Init().ignore();

  // create a new sample handler to describe the data files we use
  SH::SampleHandler sh;

  // use SampleHandler to scan all of the subdirectories of a directory for particular MC single file:
  SH::scanDQ2 (sh, "user.tomoe.tutorial2016.AOD.1");

  // set the name of the tree in our files
  // in the xAOD the TTree containing the EDM containers is "CollectionTree"
  sh.setMetaString ("nc_tree", "CollectionTree");

  // print out the samples we found
  sh.print ();

  // this is the basic description of our job
  EL::Job job;
  job.sampleHandler (sh); // use SampleHandler in this job
  job.options()->setDouble (EL::Job::optMaxEvents, 10);

  // define an output and an ntuple associated to that output
  EL::OutputStream output  ("myOutput");
  job.outputAdd (output);
  EL::NTupleSvc *ntuple = new EL::NTupleSvc ("myOutput");
  job.algsAdd (ntuple);

  // add our algorithm to the job
  MyAnalysisAlg *alg = new MyAnalysisAlg;

  // later on we'll add some configuration options for our algorithm that go here
  job.algsAdd (alg);
  alg->outputName = "myOutput";

  // make the driver we want to use:
  // this one works by running the algorithm directly:
  EL::PrunDriver driver;
  driver.options()->setString("nc_outputSampleName", "user.tomoe.tutorial2016.4");
  // we can use other drivers to run things on the Grid, with PROOF, etc.

  // process the job using the driver
  driver.submitOnly (job, submitDir);
}
</pre>
ローカルで実行する場合に比べて、scanとdriverが変わっています。では、投入します。
<dl>
<dd>$ root -l -b -q '$ROOTCOREDIR/scripts/load_packages.C' 'ATestSubmit.cxx ("myGridJob")'</dd>
</dl>
投入に少々時間がかかります。ジョブが終わればダウンロードしてみましょう。
<dl>
<dd>$ rucio download user.tomoe.tutorial2016.4_hist/</dd>
<dd>$ root user.tomoe.tutorial2016.6_hist/user.tomoe.7946627._000001.hist-output.root  </dd>
<dd>root [1] TBrowser t  </dd>
</dl>
グリッドで処理することが出来ました。

         </p>
      <!-- /#main --></div>
      <!-- /#sub --></div>
      <div id="pageTop">
         <a href="#">ページのトップへ戻る</a>
      <!-- /#pageTop --></div>
   <!-- /#contents --></div>
<!-- /#top --></div>
</body>
</html>
